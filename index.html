<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>簡易排班表</title>
  <style>
    body{margin:0;background:#000;color:#fff;font:18px/1.6 "Times New Roman",serif}
    .stage{max-width:1000px;margin:30px auto;padding:0 0}
    .panel{background:#111;border:1px solid #333;padding:20px}
    header{text-align:center;margin-bottom:18px}
    .range{display:inline-block;border:1px solid #444;padding:6px 10px;border-radius:6px}
    .toolbar{margin-top:10px}
    button{background:#444;color:#fff;border:1px solid #666;padding:6px 12px;margin:0 4px;cursor:pointer;font-size:16px;border-radius:6px}
    .btn-red{background:#b00;border-color:#900}

    h2.section{color:#b00;text-align:center;margin:16px 0 10px;font-size:22px;font-weight:700}

    table{width:100%;border-collapse:collapse;background:#000;color:#fff;margin:0 0 10px}
    th,td{border:1px solid #b00;text-align:center;padding:6px;font-size:16px}
    th{background:#111;font-weight:700}
    .name{font-weight:700}
    .day{display:block;font-weight:700}
    .date{display:block;font-size:13px;color:#ffb3b0}
    select{width:100%;background:#000;color:#fff;border:1px solid #444;padding:3px 4px;font-size:15px}
    .foot{text-align:center;font-size:14px;margin-top:18px;color:#aaa}
    html,body{overflow-x:hidden}
    .addRowBtn{text-align:right;margin-bottom:20px}
  </style>
</head>
<body>
  <div class="stage">
    <main class="panel">
      <header>
        <div id="rangeText" class="range">--/-- – --/--</div>
        <div class="toolbar">
          <button id="btnSave">儲存</button>
          <button id="btnLoad">載入</button>
          <button id="btnClear">清空資料</button>
          <button id="btnShotDaYe" class="btn-red">下載大業店</button>
          <button id="btnShotGueishan" class="btn-red">下載龜山店</button>
          <button id="btnShotMerge" class="btn-red">合併下載</button>
        </div>
      </header>

      <section id="sec-daye">
        <h2 class="section">大業店</h2>
        <div class="addRowBtn"><button class="btn-red" onclick="addRow('da-ye')">+ 新增人員</button></div>
        <table id="table-da-ye"></table>
      </section>

      <section id="sec-gueishan">
        <h2 class="section">龜山店</h2>
        <div class="addRowBtn"><button class="btn-red" onclick="addRow('gueishan')">+ 新增人員</button></div>
        <table id="table-gueishan"></table>
      </section>

      <div class="foot">每次變更自動儲存（僅儲存在此瀏覽器）。</div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
  const DAYS = ["週一","週二","週三","週四","週五","週六","週日"];
  const START_H = 15, END_H = 24, STEP_MIN = 30;
  const DEFAULT_ROWS = 7;
  const KEY = 'simpleShift_min';

  const $ = (s, r=document)=>r.querySelector(s);
  const pad = n => String(n).padStart(2,'0');
  const fmt = d => (d.getMonth()+1)+"/"+d.getDate();

  function calcWedToMonRange(base=new Date()){
    const d=new Date(base); const dow=d.getDay();
    const back=(dow-3+7)%7;
    const wed=new Date(d); wed.setDate(d.getDate()-back); wed.setHours(0,0,0,0);
    const mon=new Date(wed); mon.setDate(wed.getDate()+5);
    return {wed, mon};
  }
  function headerDates(){
    const {wed}=calcWedToMonRange();
    const offsets=[5,6,0,1,2,3,4];
    return offsets.map(off=>{const x=new Date(wed); x.setDate(wed.getDate()+off); return x;});
  }

  function buildOptions(){
    const frag=document.createDocumentFragment();
    const add=(v,t)=>{const o=document.createElement('option');o.value=v;o.textContent=t;frag.appendChild(o)};
    add('', ''); add('X','X');
    const total=(END_H-START_H)*60;
    for(let m=0;m<total;m+=STEP_MIN){
      const h1=START_H+Math.floor(m/60), m1=m%60; const n=m+STEP_MIN; const h2=START_H+Math.floor(n/60), m2=n%60;
      const label=`${pad(h1)}:${pad(m1)}–${pad(h2)}:${pad(m2)}`; add(label,label);
    }
    return frag;
  }
  const OPTION_FRAG = buildOptions();

  function buildTable(tableId){
    const tbl=$("#"+tableId); tbl.innerHTML='';
    const thead=document.createElement('thead'); const trh=document.createElement('tr');
    const thName=document.createElement('th'); thName.textContent='姓名'; trh.appendChild(thName);
    const dates=headerDates();
    DAYS.forEach((d,i)=>{const th=document.createElement('th'); const d1=document.createElement('span'); d1.className='day'; d1.textContent=d; const d2=document.createElement('span'); d2.className='date'; d2.textContent=fmt(dates[i])+(i===1?'（休）':''); th.appendChild(d1); th.appendChild(d2); trh.appendChild(th)});
    thead.appendChild(trh); tbl.appendChild(thead);

    const tbody=document.createElement('tbody');
    for(let r=0;r<DEFAULT_ROWS;r++) addRowToTable(tbody);
    tbl.appendChild(tbody);
  }

  function addRowToTable(tbody){
    const tr=document.createElement('tr');
    const tdName=document.createElement('td'); tdName.className='name'; tdName.contentEditable=true; tdName.spellcheck=false; tdName.addEventListener('input', autoSave); tr.appendChild(tdName);
    for(let c=0;c<7;c++){const td=document.createElement('td'); const sel=document.createElement('select'); sel.appendChild(OPTION_FRAG.cloneNode(true)); sel.addEventListener('change', autoSave); td.appendChild(sel); tr.appendChild(td)}
    tbody.appendChild(tr);
  }

  function addRow(store){
    const tbl=$("#table-"+store);
    const tbody=tbl.querySelector('tbody');
    addRowToTable(tbody);
    autoSave();
  }

  function snapshot(){
    const data={};
    ['da-ye','gueishan'].forEach(key=>{
      const rows=[...$("#table-"+key).querySelectorAll('tbody tr')].map(tr=>{
        const name=tr.children[0].textContent.trim();
        const days=[...tr.querySelectorAll('select')].map(s=>s.value);
        return {name,days};
      });
      data[key]=rows;
    });
    return data;
  }
  function autoSave(){localStorage.setItem(KEY, JSON.stringify(snapshot()));}
  function restore(data){
    if(!data) return;
    ['da-ye','gueishan'].forEach(key=>{
      const tbl=$("#table-"+key); buildTable(tbl.id);
      const rows=data[key]||[]; const tbody=tbl.querySelector('tbody');
      rows.forEach((row,idx)=>{
        if(idx<tbody.children.length){
          const tr=tbody.children[idx]; tr.children[0].textContent=row.name||''; [...tr.querySelectorAll('select')].forEach((s,i)=>{s.value=row.days?.[i]||''});
        } else {
          addRowToTable(tbody);
          const tr=tbody.lastChild; tr.children[0].textContent=row.name||''; [...tr.querySelectorAll('select')].forEach((s,i)=>{s.value=row.days?.[i]||''});
        }
      });
    });
  }

  async function capture(el){return await html2canvas(el,{backgroundColor:'#000',scale:2})}
  function downloadDataURL(url,name){
    const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove();
    const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||(navigator.platform==='MacIntel'&&navigator.maxTouchPoints>1);
    if(isIOS){const w=window.open(); if(w){w.document.write('<title>'+name+'</title><img src="'+url+'" style="width:100%;display:block">');}}
  }

  async function shotOne(secId, prefix){
    const title=$('#rangeText').textContent.replace(/\s|–/g,'_');
    const c=await capture($(secId)); downloadDataURL(c.toDataURL('image/png'), prefix+'_'+title+'.png');
  }
  async function shotMerge(){
    const title=$('#rangeText').textContent.replace(/\s|–/g,'_');
    const c1=await capture($('#sec-daye')); const c2=await capture($('#sec-gueishan'));
    const w=c1.width+c2.width, h=Math.max(c1.height,c2.height);
    const combo=document.createElement('canvas'); combo.width=w; combo.height=h; const g=combo.getContext('2d');
    g.fillStyle='#000'; g.fillRect(0,0,w,h); g.drawImage(c1,0,0); g.drawImage(c2,c1.width,0);
    downloadDataURL(combo.toDataURL('image/png'),'並列_'+title+'.png');
  }

  (function init(){
    const {wed,mon}=calcWedToMonRange(); $('#rangeText').textContent=fmt(wed)+' – '+fmt(mon);
    buildTable('table-da-ye'); buildTable('table-gueishan');
    try{const data=JSON.parse(localStorage.getItem(KEY)||'null'); if(data) restore(data);}catch(e){}

    $('#btnSave').addEventListener('click',()=>{autoSave(); $('#btnSave').textContent='已儲存'; setTimeout(()=>$('#btnSave').textContent='儲存',900)});
    $('#btnLoad').addEventListener('click',()=>{const d=JSON.parse(localStorage.getItem(KEY)||'null'); restore(d)});
    $('#btnClear').addEventListener('click',()=>{if(confirm('確定要清空全部資料嗎？')){localStorage.removeItem(KEY); location.reload();}});
    $('#btnShotDaYe').addEventListener('click',()=>shotOne('#sec-daye','大業店'));
    $('#btnShotGueishan').addEventListener('click',()=>shotOne('#sec-gueishan','龜山店'));
    $('#btnShotMerge').addEventListener('click',shotMerge);
  })();
  </script>
</body>
</html>