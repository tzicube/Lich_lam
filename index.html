<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>簡易排班表 — 紅白黑主題</title>
  <style>
    :root{
      --bg:#0b0b0c;
      --panel:#121214;
      --text:#ffffff;
      --muted:#c8c8c8;
      --accent:#e53935;
      --border:#26262a;    
      --cell:#121417;
      --cell2:#15181b;
      --today:#1a0e0e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.65 system-ui,Roboto,Segoe UI,Helvetica,Arial}

    .logo-fixed{position:fixed;left:14px;top:14px;z-index:50;display:flex;align-items:center;gap:10px}
    .logo-fixed img{width:42px;height:42px;border-radius:8px;border:1px solid var(--border);background:#fff;object-fit:contain}
    .logo-fixed .brand{font-weight:800;letter-spacing:.5px;color:#fff}

    /* 舞台全寬，去掉左右間距避免漏邊 */
    .stage-wrap{max-width:100%;margin:72px auto 40px;padding:0}
    #stage{display:block;width:100%}

    .wrap{transform-origin: top center;width:100%}
    body.noscroll{overflow:hidden}
    .wrap.scaled{will-change:transform}

    .wrap{background:var(--panel);border:1px solid var(--border);border-radius:0;box-shadow:none;padding:18px;width:100%}
    header{display:flex;align-items:center;gap:12px;margin-bottom:10px;flex-wrap:wrap}
    .date-badge{font-size:18px;letter-spacing:.5px;color:#fff;background:#1a1a1d;border:1px solid var(--border);border-radius:10px;padding:6px 12px}
    .hint{color:var(--muted)}
    .toolbar{display:flex;gap:8px;margin-left:auto}
    button{background:#1a1a1d;border:1px solid var(--border);color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    button:hover{background:#202023}
    .btn-red{background:var(--accent);border-color:#d32f2f}
    .btn-red:hover{background:#d12a26}

    .board{margin-top:16px;background:linear-gradient(180deg,#131316,#0f0f12);border:1px solid var(--border);border-radius:0;padding:16px}
    h2.section{color:var(--accent);text-align:center;margin:10px 0 8px;font-weight:800;letter-spacing:1px}
    .tablewrap{overflow:visible;border-radius:0;border:1px solid #2a2a2e;width:100%}
    table{width:100%;border-collapse:collapse;background:#0f1114}
    th,td{border:1px solid #2a2a2e}
    th{background:#141418;color:#fff;font-weight:700}
    th:first-child, td:first-child{min-width:160px}
    th,td{padding:14px 14px;text-align:center;white-space:nowrap}
    .name{background:#121216;font-weight:700}
    select{width:100%;background:var(--cell);color:#fff;border:1px solid #303036;border-radius:12px;padding:12px 16px;font-size:16px;line-height:1.3;min-height:48px;min-width:200px;white-space:nowrap;font-variant-numeric:tabular-nums}
    .subbar{display:flex;justify-content:space-between;align-items:center;margin:6px 0 12px;color:var(--muted)}
    .add-row{background:#1a1a1d;border-color:#2a2a2e}
    .sticky-note{color:#bdbdbd;font-size:12px}
    .foot{margin-top:18px;text-align:center;color:#bdbdbd}
    .pill{display:inline-block;border:1px dashed #b71c1c;color:#ffcccb;padding:3px 8px;border-radius:999px;margin-left:6px}
    .today-col{background:var(--today) !important}
    .clock{font-size:14px; opacity:.9}
    .day-label{font-weight:800}
    .date-label{font-size:12px;color:#ffb3b0}

    .shot-area{max-width:1280px;margin:8px auto 40px;padding:0 16px}
    .shot-grid{display:grid;grid-template-columns:1fr;gap:12px}
    .shot-card{background:#111;border:1px solid var(--border);border-radius:14px;padding:10px}
    .shot-card img{width:100%;height:auto;border-radius:10px}

    @media(max-width:768px){
      .date-badge{font-size:16px}
      th:first-child, td:first-child{min-width:100px}
      select{min-width:140px;font-size:15px;padding:10px 12px}
    }
  </style>
</head>
<body>
  <div class="logo-fixed">
    <img id="logoImg" alt="logo"/>
    <span class="brand">東山鴨</span>
  </div>

  <div class="stage-wrap">
    <div id="stage">
      <main class="wrap">
        <header>
          <span class="date-badge" id="rangeText">--/-- – --/--</span>
          <span class="hint">排班區間：<b>週三</b> → <b>週一</b>（週二公休）</span>
          <span class="date-badge clock" id="clock">--:--:--</span>
          <div class="toolbar">
            <button id="btnSave">儲存</button>
            <button id="btnLoad">載入</button>
            <button id="btnClear">清空資料</button>
            <button id="btnShotDaYe" class="btn-red">下載大業店</button>
            <button id="btnShotGueishan" class="btn-red">下載龜山店</button>
            <button id="btnShotMerge" class="btn-red">合併下載（左右）</button>
            <button id="btnShot" style="display:none">下載整頁</button>
          </div>
        </header>

        <section class="board" id="store-da-ye">
          <h2 class="section">大業店</h2>
          <div class="subbar">
            <div class="sticky-note">可直接修改姓名。<span class="pill">新增人員 →</span></div>
            <button class="add-row" data-store="da-ye">+ 新增人員</button>
          </div>
          <div class="tablewrap"><table id="table-da-ye"></table></div>
        </section>

        <section class="board" id="store-gueishan">
          <h2 class="section">龜山店</h2>
          <div class="subbar">
            <div class="sticky-note">可直接修改姓名。<span class="pill">新增人員 →</span></div>
            <button class="add-row" data-store="gueishan">+ 新增人員</button>
          </div>
          <div class="tablewrap"><table id="table-gueishan"></table></div>
        </section>

        <div class="foot">每次變更自動儲存（僅儲存在此瀏覽器）。</div>
      </main>
    </div>
  </div>

  <div class="shot-area" id="shotArea" hidden>
    <div class="shot-grid" id="shotGrid"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
  // ====== 設定 ======
  const DAYS = ["週一","週二","週三","週四","週五","週六","週日"]; // Mon..Sun (zh-TW)
  const START_H = 15; // 15:00 ~ 24:00
  const END_H = 24;
  const STEP_MIN = 30; // 每 30 分鐘
  const STORES = [
    { key: 'da-ye', tableId: 'table-da-ye', sectionId:'store-da-ye' },
    { key: 'gueishan', tableId: 'table-gueishan', sectionId:'store-gueishan' }
  ];

  const btnSave  = document.getElementById('btnSave');
  const btnLoad  = document.getElementById('btnLoad');
  const btnClear = document.getElementById('btnClear');
  const btnShot  = document.getElementById('btnShot');
  const btnShotDaYe = document.getElementById('btnShotDaYe');
  const btnShotGueishan = document.getElementById('btnShotGueishan');
  const btnShotMerge = document.getElementById('btnShotMerge');

  // Demo logo
  document.getElementById('logoImg').src = 'logo.png';

  // ====== 區間（週三 → 週一） ======
  function calcWedToMonRange(baseDate=new Date()){
    const d = new Date(baseDate);
    const dow = d.getDay(); // 0=Sun..6=Sat
    const deltaBack = (dow - 3 + 7) % 7; // 回到本週的週三
    const start = new Date(d);
    start.setDate(d.getDate() - deltaBack);
    start.setHours(0,0,0,0);
    const end = new Date(start);
    end.setDate(start.getDate() + 5); // Wed..Mon
    return {start, end};
  }
  function fmtMD(x){return `${x.getMonth()+1}/${x.getDate()}`}
  (function initRange(){
    const {start,end} = calcWedToMonRange(new Date());
    document.getElementById('rangeText').textContent = `${fmtMD(start)} – ${fmtMD(end)}`;
  })();

  // ====== 產生 30 分鐘區段 ======
  function buildSlotOptions(){
    const opts = [{value:"",label:""},{value:"X",label:"X"}];
    const totalMin = (END_H-START_H)*60;
    for(let m=0;m<totalMin;m+=STEP_MIN){
      const h = START_H + Math.floor(m/60);
      const mm = m%60;
      const nextMin = m+STEP_MIN;
      const h2 = START_H + Math.floor(nextMin/60);
      const mm2 = nextMin%60;
      const label = `${pad(h)}:${pad(mm)}–${pad(h2)}:${pad(mm2)}`;
      opts.push({value:label,label});
    }
    return opts;
  }
  function pad(n){return String(n).padStart(2,'0')}
  const SLOT_OPTIONS = buildSlotOptions();

  // ====== 畫表格 ======
  function createTable(storeKey, tableId){
    const table = document.getElementById(tableId);
    table.innerHTML = '';

    const thead = document.createElement('thead');
    const trH = document.createElement('tr');
    const thName = document.createElement('th');
    thName.textContent = '姓名';
    trH.appendChild(thName);

    DAYS.forEach((d,idx) => {
      const th = document.createElement('th');
      const daySpan = document.createElement('div'); daySpan.textContent = d; daySpan.className = 'day-label';
      const dateSpan = document.createElement('div'); dateSpan.className = 'date-label'; dateSpan.setAttribute('data-day-index', idx);
      th.appendChild(daySpan); th.appendChild(dateSpan); trH.appendChild(th);
    });
    thead.appendChild(trH); table.appendChild(thead);

    const tbody = document.createElement('tbody');
    table.appendChild(tbody);

    for(let i=0;i<5;i++) addRow(storeKey);
  }

  function addRow(storeKey, rowData=null){
    const table = document.getElementById(`table-${storeKey}`);
    const tbody = table.querySelector('tbody');
    const tr = document.createElement('tr');

    const tdName = document.createElement('td');
    tdName.className='name'; tdName.contentEditable = true; tdName.spellcheck = false;
    tdName.textContent = rowData?.name || '';
    tdName.addEventListener('input', autoSave);
    tr.appendChild(tdName);

    for(let i=0;i<DAYS.length;i++){
      const td = document.createElement('td');
      const sel = document.createElement('select');
      SLOT_OPTIONS.forEach(o=>{ const op=document.createElement('option'); op.value=o.value; op.textContent=o.label; sel.appendChild(op); });
      sel.value = rowData?.days?.[i] || '';
      sel.addEventListener('change', autoSave);
      td.appendChild(sel); tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }

  // ====== 儲存 / 載入（localStorage） ======
  function snapshot(){
    const data = {};
    for(const s of STORES){
      data[s.key] = [];
      const rows = document.querySelectorAll(`#${s.tableId} tbody tr`);
      rows.forEach(tr=>{
        const name = tr.children[0].textContent.trim();
        const days = [];
        for(let i=1;i<=DAYS.length;i++){
          const sel = tr.children[i]?.querySelector('select');
          days.push(sel ? sel.value : '');
        }
        data[s.key].push({name,days});
      });
    }
    return data;
  }
  function restore(data){
    if(!data) return;
    for(const s of STORES){
      const table = document.getElementById(s.tableId);
      table.innerHTML='';
      createTable(s.key, s.tableId);
      const tbody = table.querySelector('tbody'); tbody.innerHTML='';
      (data[s.key]||[]).forEach(row=>addRow(s.key,row));
      if((data[s.key]||[]).length===0){ for(let i=0;i<5;i++) addRow(s.key); }
    }
  }
  function autoSave(){ localStorage.setItem('simpleShift', JSON.stringify(snapshot())); }

  // ====== 實時時間 & 標頭日期 ======
  function setHeaderDates(){
    const {start} = calcWedToMonRange(new Date()); // 起點：週三
    const offsets = [5,6,0,1,2,3,4]; // 週一..週日 相對週三的位移
    STORES.forEach(s=>{
      const table = document.getElementById(s.tableId); if(!table) return;
      offsets.forEach((off,idx)=>{
        const d = new Date(start); d.setDate(start.getDate()+off);
        let label = fmtMD(d); if(idx===1) label += '（休）';
        const el = table.querySelector(`.date-label[data-day-index="${idx}"]`);
        if(el) el.textContent = label;
      });
    });
  }
  function updateClock(){
    const now=new Date(); const hh=String(now.getHours()).padStart(2,'0'); const mm=String(now.getMinutes()).padStart(2,'0'); const ss=String(now.getSeconds()).padStart(2,'0');
    document.getElementById('clock').textContent = `${hh}:${mm}:${ss}`;
  }
  function updateRangeIfNeeded(){
    const {start,end}=calcWedToMonRange(new Date()); const text=`${fmtMD(start)} – ${fmtMD(end)}`; const el=document.getElementById('rangeText'); if(el.textContent!==text) el.textContent=text;
  }
  function markToday(){
    const dow=new Date().getDay(); const idx=(dow+6)%7; // Mon=0
    const apply=(tableId)=>{ const table=document.getElementById(tableId); if(!table) return; table.querySelectorAll('th,td').forEach(c=>c.classList.remove('today-col')); const rows=table.querySelectorAll('tr'); rows.forEach(r=>{ const cell=r.children[idx+1]; if(cell) cell.classList.add('today-col'); }); };
    STORES.forEach(s=>apply(s.tableId));
  }
  clearInterval(window.__tick__); window.__tick__ = setInterval(()=>{ updateClock(); updateRangeIfNeeded(); markToday(); setHeaderDates(); }, 1000);

  // ====== 初始化 ======
  STORES.forEach(s=>createTable(s.key, s.tableId));
  updateClock(); markToday(); updateRangeIfNeeded(); setHeaderDates();

  // ====== 事件 ======
  document.querySelectorAll('.add-row').forEach(btn=>{ btn.addEventListener('click',()=>{ addRow(btn.dataset.store); autoSave(); }); });
  btnSave.addEventListener('click',()=>{ autoSave(); btnSave.textContent='已儲存'; setTimeout(()=>btnSave.textContent='儲存',900); });
  btnLoad.addEventListener('click',()=>{ const data=JSON.parse(localStorage.getItem('simpleShift')||'{}'); restore(data); });
  btnClear.addEventListener('click',()=>{ if(confirm('確定要清空全部資料嗎？')){ localStorage.removeItem('simpleShift'); location.reload(); } });

  // ====== 匯出工具（避免縮放時截圖變小） ======
  async function captureElement(el){
    const wrap=document.querySelector('.wrap'); const prev=wrap.style.transform; const wasScaled=wrap.classList.contains('scaled'); wrap.style.transform=''; wrap.classList.remove('scaled');
    const canvas=await html2canvas(el,{backgroundColor:'#0b0b0c',scale:2});
    wrap.style.transform=prev; if(wasScaled) wrap.classList.add('scaled');
    return canvas;
  }
  function downloadDataURL(dataURL, filename){
    const a=document.createElement('a'); a.href=dataURL; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
    const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||(navigator.platform==='MacIntel'&&navigator.maxTouchPoints>1); if(isIOS){ const w=window.open(); if(w){ w.document.write(`<title>${filename}</title><img src="${dataURL}" style="width:100%;height:auto;display:block"/>`); } }
  }

  // 下載整頁（giữ để tương thích）
  async function downloadPNG(){ const title=document.getElementById('rangeText').textContent.replace(/\s|–/g,'_'); const c=await captureElement(document.body); downloadDataURL(c.toDataURL('image/png'), '排班_'+title+'.png'); }
  btnShot.addEventListener('click', downloadPNG);

  // 下載單一門店
  btnShotDaYe.addEventListener('click', async ()=>{ const title=document.getElementById('rangeText').textContent.replace(/\s|–/g,'_'); const c=await captureElement(document.getElementById('store-da-ye')); downloadDataURL(c.toDataURL('image/png'), '大業店_'+title+'.png'); });
  btnShotGueishan.addEventListener('click', async ()=>{ const title=document.getElementById('rangeText').textContent.replace(/\s|–/g,'_'); const c=await captureElement(document.getElementById('store-gueishan')); downloadDataURL(c.toDataURL('image/png'), '龜山店_'+title+'.png'); });

  // 合併下載（左右拼接）
  btnShotMerge.addEventListener('click', async ()=>{
    const title=document.getElementById('rangeText').textContent.replace(/\s|–/g,'_');
    const c1=await captureElement(document.getElementById('store-da-ye'));
    const c2=await captureElement(document.getElementById('store-gueishan'));
    const w=c1.width+c2.width; const h=Math.max(c1.height,c2.height);
    const combo=document.createElement('canvas'); combo.width=w; combo.height=h; const g=combo.getContext('2d');
    g.fillStyle='#0b0b0c'; g.fillRect(0,0,w,h);
    g.drawImage(c1,0,0); g.drawImage(c2,c1.width,0);
    downloadDataURL(combo.toDataURL('image/png'), '並列_'+title+'.png');
  });

  // ====== 測試（Console） ======
  (function runTests(){
    const log=(m)=>console.log('%c[Test] '+m,'color:#ff8a80');
    const opts=buildSlotOptions(); const expected=(END_H-START_H)*2+2; console.assert(opts.length===expected,'時段數量應為 18 + 2'); console.assert(opts.at(-1).value==='23:30–24:00','最後一段 23:30–24:00'); log('Slot options OK');
    const d=new Date('2025-09-29T00:00:00'); const r=calcWedToMonRange(d); console.assert(fmtMD(r.start)==='9/24' && fmtMD(r.end)==='9/29','區間應為 9/24–9/29'); log('Range calc OK');
    setHeaderDates(); const labels=document.querySelectorAll('#table-da-ye .date-label'); console.assert(labels.length===7 && Array.from(labels).every(n=>n.textContent!=='') ,'7 天標籤應有值'); log('Header dates OK');
    console.assert(typeof btnShotMerge!=="undefined",'合併下載按鈕存在');
  })();
  </script>
</body>
</html>
